# Development

## Architecture

```
SwiftUI (MenuBarExtra, .window style)
    │
    ├── DevcapApp.swift        App entry point
    ├── AppState               @MainActor ObservableObject, @AppStorage settings
    ├── MenubarView            Main popover with project tree
    ├── SettingsView            User preferences (path, period, interval)
    ├── ProjectSection         Collapsible project → branch → commit rows
    └── DevcapBridge           Swift ↔ C FFI wrapper
            │
            ▼
    devcap-ffi/                Rust staticlib + cbindgen C header
            │
            ▼
    devcap-core                External crate (git scanning, discovery, models)
```

### Data flow

1. `AppState.refresh()` calls `DevcapBridge.scan(path, period, author)`
2. Bridge calls C FFI function `devcap_scan()` → returns JSON string
3. JSON is decoded into `[ProjectLog]` (Swift `Codable` structs)
4. SwiftUI views render the tree via `@Published` properties

### FFI boundary

Rust exposes three C functions via `devcap-ffi/src/lib.rs`:

| Function | Purpose |
|----------|---------|
| `devcap_scan` | Scan repos, return JSON `Vec<ProjectLog>` |
| `devcap_default_author` | Get `git config user.name` |
| `devcap_free_string` | Free returned C strings |

The C header `DevcapApp/Bridge/devcap.h` is auto-generated by `cbindgen` during `cargo build`.

### JSON mapping

Rust uses `snake_case` keys (`commit_type`, `relative_time`). Swift maps these via `CodingKeys`. Key models:

| Rust | Swift | Notes |
|------|-------|-------|
| `ProjectLog` | `ProjectLog` | `origin: Option<RepoOrigin>` → `origin: String?` |
| `BranchLog` | `BranchLog` | |
| `Commit` | `Commit` | `commit_type` → `commitType` |

Period values: `"today"`, `"yesterday"`, `"week"`, `"7d"`

## File structure

```
DevcapApp/
├── Bridge/
│   ├── devcap.h               Auto-generated C header
│   └── DevcapBridge.swift     FFI wrapper (C string lifecycle + JSON decode)
├── Models/
│   ├── AppState.swift         App state, scan logic, auto-refresh timer
│   └── DevcapData.swift       Codable structs (ProjectLog, BranchLog, Commit)
├── Views/
│   ├── MenubarView.swift      Main menubar popover
│   ├── ProjectSection.swift   Project/branch/commit tree rows
│   └── SettingsView.swift     Preferences window
├── DevcapApp.swift            @main entry point
└── Info.plist                 LSUIElement = true (no Dock icon)

devcap-ffi/
├── src/lib.rs                 FFI exports (scan, default_author, free)
├── build.rs                   cbindgen header generation
└── Cargo.toml                 Dependencies (devcap-core, serde_json, rayon)
```

## Building from source

### Prerequisites

- macOS 14.0+, Xcode 16+
- Rust toolchain (`rustup`)
- [XcodeGen](https://github.com/yonaskolb/xcodegen) — `brew install xcodegen`

### Commands

```bash
make ffi          # Build Rust static library (release)
make xcode        # Generate Xcode project from project.yml
make build        # Full pipeline: ffi → xcode → xcodebuild
make clean        # Remove all build artifacts
```

Or open `DevcapApp.xcodeproj` in Xcode and press `Cmd+R` — the pre-build script runs `cargo build --release` automatically.

## Updating devcap-core

```bash
make update-core
```

This runs `cargo update -p devcap-core`, prints the new version, and rebuilds the FFI library.

After updating, check for model changes:

```bash
# See what changed in core since last lock
cd devcap-ffi && cargo tree -p devcap-core

# If ProjectLog/BranchLog/Commit fields changed:
# 1. Update DevcapApp/Models/DevcapData.swift (add/remove fields)
# 2. Update Views if new data should be displayed
# 3. FFI layer (lib.rs) usually needs no changes — JSON passthrough
```

## Linting

All linters run in CI on every push (`.github/workflows/lint.yml`).

### Run all linters

```bash
make lint
```

### Rust (fmt + clippy)

```bash
make lint-rust
```

- **`cargo fmt --check`** — enforces consistent formatting (run `cargo fmt` to auto-fix)
- **`cargo clippy`** — static analysis with strict lints configured in `Cargo.toml`:
  - `unwrap_used = "deny"`, `todo = "deny"`
  - `expect_used = "warn"`, `dbg_macro = "warn"`

### Swift (SwiftLint)

```bash
make lint-swift
```

Configuration: `.swiftlint.yml` in the project root.

Install SwiftLint: `brew install swiftlint`

Key rules:
- `force_unwrapping` — opt-in, matches Rust's strict unwrap policy
- `file_length` — warning at 400 lines, error at 800
- `function_body_length` — warning at 50 lines, error at 80
- `line_length` — warning at 150 characters

## Key design decisions

- **LSUIElement** — app has no Dock icon, menubar-only via `MenuBarExtra`
- **JSON over FFI** — Rust serializes to JSON, Swift decodes. Simple, no complex C structs
- **XcodeGen** — `project.yml` is the source of truth, `.xcodeproj` is generated
- **Rayon** — parallel repo scanning in the FFI layer for performance
- **@AppStorage** — all user settings persist automatically via UserDefaults
